async function init(){let e=null;await apex.server.process("GET_EPHEMERAL_TOKEN",{},{success:t=>{e=t.client_secret.value}}),pc=new RTCPeerConnection;const t=document.createElement("audio");t.autoplay=!0,pc.ontrack=(e=>t.srcObject=e.streams[0]);const a=await navigator.mediaDevices.getUserMedia({audio:!0});pc.addTrack(a.getTracks()[0]),dc=pc.createDataChannel("oai-events"),dc.addEventListener("message",e=>{console.log(e.data);const t=JSON.parse(e.data);if("response.done"===t.type)if("completed"===t.response.status){if(0===t.response.output.length)return;const e=t.response.output[0].content,a=e.find(e=>"audio"===e.type);null!=a&&apex.item("P1_RESPONSE").setValue(a.transcript);const s=e.find(e=>"text"===e.type);null!=s&&apex.item("P1_RESPONSE").setValue(s.text)}else"failed"===t.response.status&&apex.item("P1_RESPONSE").setValue(t.response.status_details.error.message)}),dc.addEventListener("open",e=>{apex.item("P1_CONNECTION_STATE").setValue("open")}),dc.addEventListener("close",e=>{apex.item("P1_CONNECTION_STATE").setValue("close")});const s=await pc.createOffer();await pc.setLocalDescription(s);const n="https://api.openai.com/v1/realtime",o="gpt-4o-realtime-preview-2024-12-17",c=await fetch(`${n}?model=${o}`,{method:"POST",body:s.sdp,headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/sdp"}}),i={type:"answer",sdp:await c.text()};await pc.setRemoteDescription(i)}var dc=null,pc=null;const controls=apex.actions.createContext("controls",document.getElementById("CONTROLS"));controls.add([{name:"START",action:(e,t,a)=>{init()}},{name:"STOP",action:(e,t,a)=>{pc.close()}},{name:"SEND",action:(e,t,a)=>{const s=apex.item("P1_TEXT").getValue(),n={type:"response.create",response:{modalities:["text"],instructions:s}};dc.send(JSON.stringify(n))}}]);